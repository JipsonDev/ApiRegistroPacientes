<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MedSecure - Sistema de Registro de Pacientes</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 900px;
        min-height: 600px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1em;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section h2 {
        color: #34495e;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e50;
        font-weight: 600;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
      }

      .btn {
        background: linear-gradient(45deg, #3498db, #2ecc71);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
      }

      .btn-logout {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        margin-left: 10px;
      }

      .btn-refresh {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        margin-left: 10px;
      }

      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .hidden {
        display: none;
      }

      .patients-section {
        margin-top: 30px;
      }

      .patients-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }

      .patient-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .patient-item h4 {
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .patient-item p {
        color: #7f8c8d;
        margin-bottom: 3px;
      }

      .patient-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }

      .btn-edit {
        background: #f39c12;
        color: white;
      }

      .btn-edit:hover {
        background: #e67e22;
      }

      .btn-delete {
        background: #e74c3c;
        color: white;
      }

      .btn-delete:hover {
        background: #c0392b;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        position: relative;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 10px;
      }

      .close:hover {
        color: black;
      }

      .modal h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
      }

      .form-row {
        display: flex;
        gap: 20px;
      }

      .form-row .form-group {
        flex: 1;
      }

      .countdown {
        font-weight: bold;
        color: #e74c3c;
      }

      .user-info {
        background: #ecf0f1;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info span {
        color: #2c3e50;
        font-weight: 600;
      }

      .token-info {
        background: #e8f5e8;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #d4edda;
      }

      .token-info.warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
      }

      .token-info.expired {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }

      .token-timer {
        font-weight: bold;
        color: #2c3e50;
      }

      .token-timer.warning {
        color: #856404;
      }

      .token-timer.expired {
        color: #721c24;
      }

      .actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
          margin: 20px;
        }

        .form-row {
          flex-direction: column;
        }

        .header h1 {
          font-size: 2em;
        }

        .actions-container {
          flex-direction: column;
          align-items: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè• MedSecure</h1>
        <p>Sistema de Registro de Pacientes</p>
      </div>

      <!-- Secci√≥n de Login -->
      <div id="loginSection">
        <div class="form-section">
          <h2>Iniciar Sesi√≥n</h2>
          <div id="loginAlert"></div>
          <form id="loginForm">
            <div class="form-group">
              <label for="username">Usuario:</label>
              <input type="text" id="username" name="username" required />
            </div>
            <div class="form-group">
              <label for="password">Contrase√±a:</label>
              <input type="password" id="password" name="password" required />
            </div>
            <button type="submit" class="btn" id="loginBtn">
              Iniciar Sesi√≥n
            </button>
          </form>
          <div id="blockInfo" class="hidden">
            <div class="alert alert-error">
              <p>Has sido bloqueado por m√∫ltiples intentos fallidos.</p>
              <p>
                Tiempo restante: <span id="countdown" class="countdown"></span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Secci√≥n Principal (despu√©s del login) -->
      <div id="mainSection" class="hidden">
        <div class="user-info">
          <span>Bienvenido, <span id="currentUser"></span></span>
          <div class="actions-container">
            <button class="btn btn-refresh" onclick="manualRefreshToken()">
              üîÑ Renovar Token
            </button>
            <button class="btn btn-logout" onclick="logout()">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>

        <!-- Informaci√≥n del Token -->
        <div id="tokenInfo" class="token-info">
          <span
            >Token v√°lido por:
            <span id="tokenTimer" class="token-timer">--:--</span></span
          >
          <span id="tokenStatus">Activo</span>
        </div>

        <!-- Registro de Pacientes -->
        <div class="form-section">
          <h2>Registrar Nuevo Paciente</h2>
          <div id="registerAlert"></div>
          <form id="registerForm">
            <div class="form-row">
              <div class="form-group">
                <label for="patientName">Nombre del Paciente:</label>
                <input
                  type="text"
                  id="patientName"
                  name="patientName"
                  required
                  pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]{2,50}$"
                  title="Solo letras y espacios (2-50 caracteres)"
                />
              </div>
              <div class="form-group">
                <label for="patientSymptom">S√≠ntoma/Enfermedad:</label>
                <select id="patientSymptom" name="patientSymptom" required>
                  <option value="">Seleccionar s√≠ntoma...</option>
                  <option value="fiebre">Fiebre</option>
                  <option value="dolor de cabeza">Dolor de cabeza</option>
                  <option value="tos">Tos</option>
                  <option value="dolor de garganta">Dolor de garganta</option>
                  <option value="fatiga">Fatiga</option>
                  <option value="nauseas">N√°useas</option>
                  <option value="vomito">V√≥mito</option>
                  <option value="diarrea">Diarrea</option>
                  <option value="dolor abdominal">Dolor abdominal</option>
                  <option value="mareos">Mareos</option>
                  <option value="dolor muscular">Dolor muscular</option>
                  <option value="congestion nasal">Congesti√≥n nasal</option>
                  <option value="perdida del gusto">P√©rdida del gusto</option>
                  <option value="perdida del olfato">P√©rdida del olfato</option>
                  <option value="dificultad respiratoria">
                    Dificultad respiratoria
                  </option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn">Registrar Paciente</button>
          </form>
        </div>

        <!-- Lista de Pacientes -->
        <div class="patients-section">
          <h2>Pacientes Registrados</h2>
          <div id="patientsAlert"></div>
          <div class="patients-list" id="patientsList">
            <div class="loading">Cargando pacientes...</div>
          </div>
        </div>
      </div>

      <!-- Modal para editar paciente -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEditModal()">&times;</span>
          <h3>Editar Paciente</h3>
          <div id="editAlert"></div>
          <form id="editForm">
            <div class="form-group">
              <label for="editPatientName">Nombre del Paciente:</label>
              <input
                type="text"
                id="editPatientName"
                name="editPatientName"
                required
                pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]{2,50}$"
                title="Solo letras y espacios (2-50 caracteres)"
              />
            </div>
            <div class="form-group">
              <label for="editPatientSymptom">S√≠ntoma/Enfermedad:</label>
              <select
                id="editPatientSymptom"
                name="editPatientSymptom"
                required
              >
                <option value="">Seleccionar s√≠ntoma...</option>
                <option value="fiebre">Fiebre</option>
                <option value="dolor de cabeza">Dolor de cabeza</option>
                <option value="tos">Tos</option>
                <option value="dolor de garganta">Dolor de garganta</option>
                <option value="fatiga">Fatiga</option>
                <option value="nauseas">N√°useas</option>
                <option value="vomito">V√≥mito</option>
                <option value="diarrea">Diarrea</option>
                <option value="dolor abdominal">Dolor abdominal</option>
                <option value="mareos">Mareos</option>
                <option value="dolor muscular">Dolor muscular</option>
                <option value="congestion nasal">Congesti√≥n nasal</option>
                <option value="perdida del gusto">P√©rdida del gusto</option>
                <option value="perdida del olfato">P√©rdida del olfato</option>
                <option value="dificultad respiratoria">
                  Dificultad respiratoria
                </option>
              </select>
            </div>
            <div style="text-align: center; margin-top: 20px">
              <button type="submit" class="btn">Guardar Cambios</button>
              <button
                type="button"
                class="btn"
                onclick="closeEditModal()"
                style="margin-left: 10px; background: #95a5a6"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Configuraci√≥n de la API
      const API_BASE_URL = "https://apiregistropacientes.onrender.com";

      // Variables globales
      let currentToken = null;
      let refreshToken = null;
      let currentUser = null;
      let blockCountdown = null;
      let editingPatientId = null;
      let tokenExpirationTime = null;
      let tokenTimerInterval = null;
      let autoRefreshInterval = null;
      let isRefreshing = false;

      // Elementos DOM
      const loginSection = document.getElementById("loginSection");
      const mainSection = document.getElementById("mainSection");
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const editForm = document.getElementById("editForm");
      const editModal = document.getElementById("editModal");
      const loginAlert = document.getElementById("loginAlert");
      const registerAlert = document.getElementById("registerAlert");
      const patientsAlert = document.getElementById("patientsAlert");
      const editAlert = document.getElementById("editAlert");
      const patientsList = document.getElementById("patientsList");
      const blockInfo = document.getElementById("blockInfo");
      const countdown = document.getElementById("countdown");
      const loginBtn = document.getElementById("loginBtn");
      const currentUserSpan = document.getElementById("currentUser");
      const tokenInfo = document.getElementById("tokenInfo");
      const tokenTimer = document.getElementById("tokenTimer");
      const tokenStatus = document.getElementById("tokenStatus");

      // Funciones para manejar el almacenamiento seguro de tokens
      function saveSessionData() {
        try {
          const sessionData = {
            accessToken: currentToken,
            refreshToken: refreshToken,
            user: currentUser,
            tokenExpiration: tokenExpirationTime,
          };
          localStorage.setItem("sessionData", JSON.stringify(sessionData));
        } catch (error) {
          console.error("Error guardando datos de sesi√≥n:", error);
        }
      }

      function loadSessionData() {
        try {
          const sessionData = localStorage.getItem("sessionData");
          if (sessionData) {
            const data = JSON.parse(sessionData);
            return {
              accessToken: data.accessToken,
              refreshToken: data.refreshToken,
              user: data.user,
              tokenExpiration: data.tokenExpiration,
            };
          }
        } catch (error) {
          console.error("Error cargando datos de sesi√≥n:", error);
        }
        return null;
      }

      function clearSessionData() {
        try {
          localStorage.removeItem("sessionData");
        } catch (error) {
          console.error("Error limpiando datos de sesi√≥n:", error);
        }
      }

      // Funciones de utilidad
      function showAlert(element, message, type = "error") {
        const alertClass =
          type === "info"
            ? "alert-info"
            : type === "success"
            ? "alert-success"
            : type === "warning"
            ? "alert-warning"
            : "alert-danger";

        element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

        // Limpiar despu√©s de tiempo espec√≠fico
        const timeout = type === "info" ? 2000 : 5000;
        setTimeout(() => {
          element.innerHTML = "";
        }, timeout);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("es-ES");
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
      }

      function startTokenTimer() {
        clearInterval(tokenTimerInterval);

        if (!tokenExpirationTime) {
          tokenTimer.textContent = "--:--";
          return;
        }

        tokenTimerInterval = setInterval(() => {
          const now = Date.now();
          const timeLeft = Math.max(
            0,
            Math.floor((tokenExpirationTime - now) / 1000)
          );

          tokenTimer.textContent = formatTime(timeLeft);

          // Cambiar estilos seg√∫n el tiempo restante
          if (timeLeft <= 0) {
            tokenInfo.className = "token-info expired";
            tokenTimer.className = "token-timer expired";
            tokenStatus.textContent = "Expirado";
            clearInterval(tokenTimerInterval);
          } else if (timeLeft <= 60) {
            tokenInfo.className = "token-info warning";
            tokenTimer.className = "token-timer warning";
            tokenStatus.textContent = "Pr√≥ximo a expirar";
          } else {
            tokenInfo.className = "token-info";
            tokenTimer.className = "token-timer";
            tokenStatus.textContent = "Activo";
          }
        }, 1000);
      }

      function setupAutoRefresh() {
        clearInterval(autoRefreshInterval);

        // Renovar autom√°ticamente 60 segundos antes de que expire
        autoRefreshInterval = setInterval(async () => {
          if (tokenExpirationTime && !isRefreshing) {
            const now = Date.now();
            const timeLeft = Math.floor((tokenExpirationTime - now) / 1000);

            if (timeLeft <= 60 && timeLeft > 0) {
              console.log("Renovando token autom√°ticamente...");
              await autoRefreshToken();
            }
          }
        }, 5000);
      }

      function startCountdown(seconds) {
        clearInterval(blockCountdown);
        blockInfo.classList.remove("hidden");
        loginBtn.disabled = true;

        blockCountdown = setInterval(() => {
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          countdown.textContent = `${minutes}:${remainingSeconds
            .toString()
            .padStart(2, "0")}`;

          if (seconds <= 0) {
            clearInterval(blockCountdown);
            blockInfo.classList.add("hidden");
            loginBtn.disabled = false;
          }
          seconds--;
        }, 1000);
      }

      // Funciones de autenticaci√≥n mejoradas
      async function login(username, password) {
        try {
          showAlert(loginAlert, "Iniciando sesi√≥n...", "info");

          const response = await fetch(`${API_BASE_URL}/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            currentToken = data.access_token;
            refreshToken = data.refresh_token;
            currentUser = data.user;

            // Configurar tiempo de expiraci√≥n del token con margen de seguridad
            tokenExpirationTime = Date.now() + (data.expires_in - 30) * 1000;

            // Guardar datos de sesi√≥n
            saveSessionData();

            currentUserSpan.textContent = currentUser;

            loginSection.classList.add("hidden");
            mainSection.classList.remove("hidden");

            showAlert(loginAlert, "Inicio de sesi√≥n exitoso", "success");

            // Iniciar temporizador del token
            startTokenTimer();
            setupAutoRefresh();

            loadPatients();
          } else {
            if (
              data.error === "Usuario bloqueado" ||
              data.error === "Bloqueado por 5 minutos"
            ) {
              const timeRemaining = data.tiempo_restante || 300;
              startCountdown(timeRemaining);
              showAlert(
                loginAlert,
                `Bloqueado por m√∫ltiples intentos fallidos. Tiempo restante: ${Math.ceil(
                  timeRemaining / 60
                )} minutos`,
                "error"
              );
            } else {
              showAlert(
                loginAlert,
                data.error +
                  (data.intentos_restantes
                    ? ` (Intentos restantes: ${data.intentos_restantes})`
                    : ""),
                "error"
              );
            }
          }
        } catch (error) {
          console.error("Error en login:", error);
          showAlert(loginAlert, "Error de conexi√≥n con el servidor", "error");
        }
      }

      async function autoRefreshToken() {
        if (isRefreshing) {
          console.log("Ya se est√° renovando el token...");
          return false;
        }

        isRefreshing = true;

        try {
          if (!refreshToken) {
            console.error("No hay refresh token disponible");
            return false;
          }

          console.log("Intentando renovar token...");

          const response = await fetch(`${API_BASE_URL}/refresh`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ refresh_token: refreshToken }),
          });

          if (response.ok) {
            const data = await response.json();

            // Actualizar token y tiempo de expiraci√≥n
            currentToken = data.access_token;
            tokenExpirationTime = Date.now() + (data.expires_in - 30) * 1000;

            // Actualizar refresh token si viene uno nuevo
            if (data.refresh_token) {
              refreshToken = data.refresh_token;
            }

            // Guardar datos actualizados
            saveSessionData();

            console.log("Token renovado exitosamente");
            startTokenTimer();

            return true;
          } else {
            console.error("Error renovando token:", response.status);
            const errorData = await response.json();
            console.error("Error details:", errorData);

            // Si el refresh token tambi√©n expir√≥, cerrar sesi√≥n
            if (response.status === 401 || response.status === 422) {
              console.log("Refresh token expirado, cerrando sesi√≥n...");
              await logout();
            }

            return false;
          }
        } catch (error) {
          console.error("Error en autoRefreshToken:", error);
          return false;
        } finally {
          isRefreshing = false;
        }
      }

      async function manualRefreshToken() {
        try {
          const success = await autoRefreshToken();
          if (success) {
            showAlert(registerAlert, "Token renovado exitosamente", "success");
          } else {
            showAlert(registerAlert, "Error renovando token", "error");
          }
        } catch (error) {
          showAlert(
            registerAlert,
            "Error renovando token manualmente",
            "error"
          );
        }
      }

      async function logout() {
        try {
          if (currentToken) {
            await fetch(`${API_BASE_URL}/logout`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${currentToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ refresh_token: refreshToken }),
            });
          }
        } catch (error) {
          console.error("Error al cerrar sesi√≥n:", error);
        }

        // Limpiar intervalos
        clearInterval(tokenTimerInterval);
        clearInterval(autoRefreshInterval);

        // Limpiar datos de sesi√≥n
        clearSessionData();

        // Limpiar variables
        currentToken = null;
        refreshToken = null;
        currentUser = null;
        tokenExpirationTime = null;
        isRefreshing = false;

        loginSection.classList.remove("hidden");
        mainSection.classList.add("hidden");

        loginForm.reset();
        registerForm.reset();
        loginAlert.innerHTML = "";
        registerAlert.innerHTML = "";
        patientsAlert.innerHTML = "";

        // Resetear timer
        tokenTimer.textContent = "--:--";
        tokenStatus.textContent = "Desconectado";
        tokenInfo.className = "token-info";
      }

      // Funci√≥n para restaurar sesi√≥n
      async function restoreSession(sessionData) {
        try {
          currentToken = sessionData.accessToken;
          refreshToken = sessionData.refreshToken;
          currentUser = sessionData.user;
          tokenExpirationTime = sessionData.tokenExpiration;

          // Verificar si el token sigue siendo v√°lido
          const now = Date.now();
          const timeLeft = Math.floor((tokenExpirationTime - now) / 1000);

          if (timeLeft <= 0) {
            console.log("Token expirado, intentando renovar...");
            const refreshed = await autoRefreshToken();
            if (!refreshed) {
              console.log("No se pudo renovar el token, cerrando sesi√≥n...");
              await logout();
              return false;
            }
          }

          // Restaurar interfaz
          currentUserSpan.textContent = currentUser;
          loginSection.classList.add("hidden");
          mainSection.classList.remove("hidden");

          // Iniciar temporizadores
          startTokenTimer();
          setupAutoRefresh();

          // Cargar pacientes
          loadPatients();

          console.log("Sesi√≥n restaurada exitosamente");
          return true;
        } catch (error) {
          console.error("Error restaurando sesi√≥n:", error);
          await logout();
          return false;
        }
      }

      // Funci√≥n mejorada para peticiones autenticadas
      async function makeAuthenticatedRequest(url, options = {}) {
        const makeRequest = async (token) => {
          const headers = {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...options.headers,
          };

          return await fetch(url, {
            ...options,
            headers,
          });
        };

        try {
          // Verificar si el token est√° pr√≥ximo a expirar ANTES de hacer la petici√≥n
          if (tokenExpirationTime) {
            const now = Date.now();
            const timeLeft = Math.floor((tokenExpirationTime - now) / 1000);

            if (timeLeft <= 30) {
              console.log(
                "Token pr√≥ximo a expirar, renovando antes de la petici√≥n..."
              );
              const refreshed = await autoRefreshToken();
              if (!refreshed) {
                console.error("No se pudo renovar el token");
                await logout();
                return null;
              }
            }
          }

          let response = await makeRequest(currentToken);

          // Si el token expir√≥ (401), intentar renovar UNA SOLA VEZ
          if (response.status === 401) {
            console.log(
              "Token expirado durante la petici√≥n, intentando renovar..."
            );

            const refreshed = await autoRefreshToken();

            if (refreshed) {
              console.log("Token renovado, repitiendo petici√≥n...");
              response = await makeRequest(currentToken);
            } else {
              console.error("No se pudo renovar el token, cerrando sesi√≥n");
              showAlert(
                patientsAlert,
                "Sesi√≥n expirada, redirigiendo al login...",
                "error"
              );
              setTimeout(() => logout(), 2000);
              return null;
            }
          }

          return response;
        } catch (error) {
          console.error("Error en makeAuthenticatedRequest:", error);
          showAlert(
            patientsAlert,
            "Error de conexi√≥n con el servidor",
            "error"
          );
          throw error;
        }
      }

      // Funciones de API mejoradas
      async function registerPatient(name, symptom) {
        if (!currentToken) {
          showAlert(
            registerAlert,
            "Debes iniciar sesi√≥n para registrar pacientes",
            "error"
          );
          return;
        }

        try {
          showAlert(registerAlert, "Registrando paciente...", "info");

          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/registro`,
            {
              method: "POST",
              body: JSON.stringify({ nombre: name, sintoma: symptom }),
            }
          );

          if (response && response.ok) {
            const data = await response.json();
            showAlert(registerAlert, data.mensaje, "success");
            registerForm.reset();
            loadPatients();
          } else if (response) {
            const data = await response.json();
            showAlert(
              registerAlert,
              data.error +
                (data.detalles ? ": " + data.detalles.join(", ") : ""),
              "error"
            );
          }
        } catch (error) {
          console.error("Error en registerPatient:", error);
          showAlert(
            registerAlert,
            "Error de conexi√≥n con el servidor",
            "error"
          );
        }
      }

      async function editPatient(id, name, symptom) {
        try {
          showAlert(editAlert, "Actualizando paciente...", "info");

          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/pacientes/${id}`,
            {
              method: "PUT",
              body: JSON.stringify({ nombre: name, sintoma: symptom }),
            }
          );

          if (response && response.ok) {
            const data = await response.json();
            showAlert(editAlert, data.mensaje, "success");
            setTimeout(() => {
              closeEditModal();
              loadPatients();
            }, 1500);
          } else if (response) {
            const data = await response.json();
            showAlert(
              editAlert,
              data.error +
                (data.detalles ? ": " + data.detalles.join(", ") : ""),
              "error"
            );
          }
        } catch (error) {
          console.error("Error en editPatient:", error);
          showAlert(editAlert, "Error de conexi√≥n con el servidor", "error");
        }
      }

      async function deletePatient(id, patientName) {
        if (
          !confirm(
            `¬øEst√°s seguro de que quieres eliminar al paciente ${patientName}?`
          )
        ) {
          return;
        }

        try {
          showAlert(patientsAlert, "Eliminando paciente...", "info");

          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/pacientes/${id}`,
            {
              method: "DELETE",
            }
          );

          if (response && response.ok) {
            const data = await response.json();
            showAlert(patientsAlert, data.mensaje, "success");
            loadPatients();
          } else if (response) {
            const data = await response.json();
            showAlert(patientsAlert, data.error, "error");
          }
        } catch (error) {
          console.error("Error en deletePatient:", error);
          showAlert(
            patientsAlert,
            "Error de conexi√≥n con el servidor",
            "error"
          );
        }
      }

      async function loadPatients() {
        try {
          patientsList.innerHTML =
            '<div class="loading">Cargando pacientes...</div>';

          const response = await makeAuthenticatedRequest(
            `${API_BASE_URL}/pacientes`
          );

          if (response && response.ok) {
            const data = await response.json();
            displayPatients(data.pacientes);
          } else if (response) {
            const data = await response.json();
            if (data.error === "Acceso denegado") {
              showAlert(
                patientsAlert,
                "No tienes permisos para ver la lista completa de pacientes",
                "warning"
              );
              patientsList.innerHTML =
                '<div class="loading">Lista disponible solo para administradores</div>';
            } else {
              showAlert(patientsAlert, data.error, "error");
            }
          }
        } catch (error) {
          showAlert(patientsAlert, "Error cargando pacientes", "error");
          patientsList.innerHTML =
            '<div class="loading">Error al cargar pacientes</div>';
        }
      }

      function displayPatients(patients) {
        if (!patients || patients.length === 0) {
          patientsList.innerHTML =
            '<div class="loading">No hay pacientes registrados</div>';
          return;
        }

        // Ordenar por fecha m√°s reciente
        patients.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        const patientsHTML = patients
          .map(
            (patient) => `
    <div class="patient-item">
        <div class="patient-actions">
            <button class="btn-small btn-edit" onclick="openEditModal(${
              patient.id
            }, '${patient.nombre}', '${patient.sintoma}')">
                ‚úèÔ∏è Editar
            </button>
            <button class="btn-small btn-delete" onclick="deletePatient(${
              patient.id
            }, '${patient.nombre}')">
                üóëÔ∏è Eliminar
            </button>
        </div>
        <h4>${patient.nombre}</h4>
        <p><strong>S√≠ntoma:</strong> ${patient.sintoma}</p>
        <p><strong>Registrado:</strong> ${formatDate(patient.timestamp)}</p>
        <p><strong>Registrado por:</strong> ${patient.usuario_registro}</p>
        <p><strong>ID:</strong> ${patient.id}</p>
    </div>
`
          )
          .join("");

        patientsList.innerHTML = patientsHTML;
      }

      // Funciones del modal
      function openEditModal(id, name, symptom) {
        editingPatientId = id;
        document.getElementById("editPatientName").value = name;
        document.getElementById("editPatientSymptom").value = symptom;
        editModal.style.display = "block";
        editAlert.innerHTML = "";
      }

      function closeEditModal() {
        editModal.style.display = "none";
        editingPatientId = null;
        editForm.reset();
        editAlert.innerHTML = "";
      }

      // Event listeners
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        await login(username, password);
      });

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("patientName").value;
        const symptom = document.getElementById("patientSymptom").value;
        await registerPatient(name, symptom);
      });

      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("editPatientName").value;
        const symptom = document.getElementById("editPatientSymptom").value;
        await editPatient(editingPatientId, name, symptom);
      });

      // Cerrar modal al hacer clic fuera de √©l
      window.onclick = function (event) {
        if (event.target === editModal) {
          closeEditModal();
        }
      };

      // Inicializaci√≥n corregida
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("Iniciando aplicaci√≥n...");

        // Intentar restaurar sesi√≥n existente
        const sessionData = loadSessionData();

        if (sessionData && sessionData.accessToken) {
          console.log("Datos de sesi√≥n encontrados, intentando restaurar...");
          const restored = await restoreSession(sessionData);

          if (!restored) {
            console.log("No se pudo restaurar la sesi√≥n");
            showAlert(
              loginAlert,
              "Sesi√≥n expirada, inicia sesi√≥n nuevamente",
              "warning"
            );
          }
        } else {
          console.log("No se encontraron datos de sesi√≥n");
          // Asegurarse de que la interfaz est√© en el estado correcto
          loginSection.classList.remove("hidden");
          mainSection.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
